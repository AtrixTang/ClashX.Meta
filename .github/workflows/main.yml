name: ClashX

on:
  push:
    tags: [ 2.* ]
  workflow_dispatch:
    inputs:
      logLevel:

env:
  FASTLANE_SKIP_UPDATE_CHECK: true
  DEVELOPER_DIR: /Applications/Xcode_13.1.app/Contents/Developer

jobs:
  build:
    runs-on: macos-11
    steps:
    - uses: actions/checkout@v2
    - name: setup Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.18.x
    
    - name: install deps
      run: |
        bash install_dependency.sh

    - name: build
      run: |
        cd ClashX
        python3 add_build_info.py
        cd ..
        xcodebuild archive -workspace ClashX.xcworkspace -scheme ClashX -archivePath archive/ClashX.xcarchive -showBuildTimingSummary -allowProvisioningUpdates

    - name: setup node
      uses: actions/setup-node@v1
      with:
        node-version: '10.x'

    - name: create dmg
      run: |
        npm install --global create-dmg
        create-dmg archive/ClashX.xcarchive/Products/Applications/ClashX.app
        mv ClashX*.dmg ClashX.dmg

    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      if: "!startsWith(github.ref, 'refs/tags/')"
      with:
        name: ClashX.dmg
        path: ClashX.dmg

    - name: upload build to github
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ClashX.dmg
        draft: true
        prerelease: true
